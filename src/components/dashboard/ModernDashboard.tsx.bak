import React, { useState, useEffect, useCallback, lazy, Suspense } from 'react'
import { useNavigate } from 'react-router-dom'
import { 
  BellIcon, 
  RefreshCwIcon, 
  EyeIcon, 
  EyeOffIcon,
  ChevronDownIcon,
  ChevronUpIcon,
  XIcon,
  AlertCircleIcon,
  CheckCircleIcon,
  InfoIcon,
  TrendingUpIcon,
  DollarSignIcon,
  UserIcon,
  GlobeIcon,
  CalendarIcon,
  BookOpenIcon,
  SparklesIcon,
  ArrowRightIcon,
  PlusIcon,
  SettingsIcon,
  Target
} from 'lucide-react'
import { useSmartDashboard, useDashboardNotifications } from '../../hooks/useSmartDashboard'
import { useAuth } from '../../contexts/AuthContext'
import { useTheme } from '../../contexts/ThemeContext'
// Removed old widget imports - now using glass versions
import SkeletonLoader from '../ui/SkeletonLoader'
import { akadaTokens } from '../../styles/tokens'
import { cn } from '../../lib/utils'

// Import glass components
import {
  GlassWelcomeCard,
  GlassWelcomeCardDark,
  GlassStatsGrid,
  GlassStatsGridDark,
  GlassActionCard,
  GlassActionCardDark,
  GlassProfileWidget,
  GlassTimelineWidget,
  GlassCostWidget,
  GlassReminderWidget,
  GlassQuickActionsWidget
} from '../glass'

// Lazy load heavy components for performance
const CostComparisonChart = lazy(() => import('./CostComparisonChart'))

interface DashboardSummary {
  greeting: string
  motivationalQuote: string
  overallStatus: 'on-track' | 'needs-attention' | 'critical'
  keyMetrics: {
    profileScore: number
    upcomingDeadlines: number
    budgetHealth: string
    matchedPrograms: number
  }
  nextBestAction: {
    text: string
    action: () => void
    priority: 'high' | 'medium' | 'low'
  }
}

interface SmartNotification {
  id: string
  type: 'deadline' | 'budget' | 'profile' | 'opportunity' | 'tip'
  priority: 'urgent' | 'high' | 'medium' | 'low'
  title: string
  message: string
  action?: {
    label: string
    onClick: () => void
  }
  dismissible: boolean
  icon: React.ReactNode
  timestamp: Date
}

interface QuickAction {
  id: string
  label: string
  description: string
  icon: React.ReactNode
  onClick: () => void
  priority: 'high' | 'medium' | 'low'
  color: string
}

interface OnboardingCardProps {
  step: number
  title: string
  description: string
  icon: React.ReactNode
  action: () => void
}

const OnboardingCard: React.FC<OnboardingCardProps> = ({ 
  step, 
  title, 
  description, 
  icon, 
  action 
}) => (
  <div 
    onClick={action}
    className="relative overflow-hidden rounded-xl bg-white/80 dark:bg-gray-900/40 backdrop-blur-xl border border-gray-200 dark:border-white/10 p-6 cursor-pointer hover:shadow-md transition-all duration-300 group"
  >
    {/* Glass effect overlay */}
    <div className="absolute inset-0 bg-gradient-to-br from-indigo-50/50 via-purple-50/30 to-pink-50/50 dark:from-indigo-500/20 dark:via-purple-500/20 dark:to-pink-500/20" />
    
    <div className="relative z-10">
      <div className="flex items-center justify-between mb-4">
        <div className="text-2xl">{icon}</div>
        <div className="w-8 h-8 bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 rounded-full flex items-center justify-center text-sm font-semibold">
          {step}
        </div>
      </div>
      <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors">
        {title}
      </h3>
      <p className="text-gray-600 dark:text-gray-400 text-sm mb-4">
        {description}
      </p>
      <div className="flex items-center text-indigo-600 dark:text-indigo-400 text-sm font-medium">
        Get Started <ArrowRightIcon className="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" />
      </div>
    </div>
    
    {/* Decorative corner */}
    <div className="absolute bottom-0 right-0 w-16 h-16 bg-white/30 dark:bg-white/10 rounded-tl-full" />
  </div>
)

const WelcomeDashboard: React.FC = () => {
  const navigate = useNavigate()
  const { theme } = useTheme()
  const isDark = theme === 'dark'
  
  return (
    <div className={`min-h-screen ${isDark 
      ? 'bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950' 
      : 'bg-gradient-to-br from-indigo-50/30 via-purple-50/20 to-pink-50/30'
    }`}>
      {/* Background Effects */}
      {isDark ? (
        <>
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(99,102,241,0.08),transparent_50%)]" />
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_70%_60%,rgba(139,92,246,0.08),transparent_50%)]" />
        </>
      ) : (
        <>
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(99,102,241,0.15),transparent_60%)]" />
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_70%_60%,rgba(168,85,247,0.12),transparent_60%)]" />
        </>
      )}
      
      <div className="relative z-10 text-center py-12 px-6">
        <div className="text-6xl mb-6">üéâ</div>
        <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-4">
          Welcome to Your Akada Dashboard!
        </h2>
        <p className="text-lg text-gray-600 dark:text-gray-400 mb-8 max-w-2xl mx-auto">
          Your personalized command center for studying abroad. Let's get you started on your journey to international education success.
        </p>
        
        <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
          <OnboardingCard 
            step={1}
            title="Complete Your Profile"
            description="Tell us about your academic dreams and preferences"
            icon={<UserIcon className="w-6 h-6" />}
            action={() => navigate('/dashboard/profile')}
          />
          <OnboardingCard 
            step={2}
            title="Set Your Budget"
            description="Know your financial limits and discover opportunities"
            icon={<DollarSignIcon className="w-6 h-6" />}
            action={() => navigate('/dashboard/calculator')}
          />
          <OnboardingCard 
            step={3}
            title="Explore Programs"
            description="Find your perfect university and program match"
            icon={<GlobeIcon className="w-6 h-6" />}
            action={() => navigate('/dashboard/search')}
          />
        </div>
        
        <div className={`mt-12 p-6 rounded-xl backdrop-blur-xl border ${
          isDark 
            ? 'bg-blue-900/40 border-blue-500/30' 
            : 'bg-blue-50/80 border-blue-200'
        } max-w-md mx-auto`}>
          <div className="text-4xl mb-3">üá≥üá¨</div>
          <h3 className="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-2">
            Made for Nigerian Students
          </h3>
          <p className="text-blue-700 dark:text-blue-300 text-sm">
            Join 1,000+ Nigerian students who have successfully secured admissions and ‚Ç¶50M+ in scholarships through Akada.
          </p>
        </div>
      </div>
    </div>
  )
}

export const ModernDashboard: React.FC<{ className?: string }> = ({ className }) => {
  const navigate = useNavigate()
  const { user, profile } = useAuth()
  const { theme } = useTheme()
  const isDark = theme === 'dark'
  const { 
    insights, 
    metrics, 
    loading, 
    refreshing,
    dismissInsight, 
    refreshDashboard, 
    getDashboardSummary, 
    getQuickActions,
    profileData,
    timelineData,
    costData,
    recommendedPrograms,
    preferences
  } = useSmartDashboard()
  
  const { notifications, hasUrgentNotifications, urgentCount } = useDashboardNotifications()
  
  // UI state
  const [isRefreshing, setIsRefreshing] = useState(false)
  const [widgetVisibility, setWidgetVisibility] = useState({
    notifications: true,
    profile: true,
    timeline: true,
    cost: true,
    chart: true,
    quickActions: true,
    reminders: true
  })
  const [expandedNotifications, setExpandedNotifications] = useState(true)
  const [showAllInsights, setShowAllInsights] = useState(false)
  const [showNotifications, setShowNotifications] = useState(false)

  // Nigerian-specific time-aware greetings
  const getTimeAwareGreeting = (): string => {
    const hour = new Date().getHours()
    
    // Get name from profile, fallback to first part of email, then "Student"
    let name = "Student"
    if (profile?.full_name) {
      // Use first name only (split by space and take first part)
      name = profile.full_name.split(' ')[0]
    } else if (user?.email) {
      // Extract name from email (part before @)
      name = user.email.split('@')[0].replace(/[._]/g, ' ').split(' ')[0]
      // Capitalize first letter
      name = name.charAt(0).toUpperCase() + name.slice(1)
    }
    
    if (hour < 12) {
      return `Good morning, ${name}! Let's make progress today üåÖ`
    } else if (hour < 18) {
      return `Good afternoon, ${name}! Keep the momentum going üí™`
    } else {
      return `Good evening, ${name}! Time to review your progress üåô`
    }
  }

  // Nigerian-specific motivational quotes
  const getMotivationalQuote = (): string => {
    const quotes = [
      "Your dreams are valid - keep pushing! üöÄ",
      "From Nigeria to the world üá≥üá¨‚úàÔ∏è",
      "Every application brings you closer to success üí´",
      "Education is the passport to the future üìö",
      "Believe in yourself and all that you are üí™",
      "Success begins with a single step forward üë£"
    ]
    return quotes[Math.floor(Math.random() * quotes.length)]
  }

  // Generate dashboard summary
  const generateDashboardSummary = (): DashboardSummary => {
    const summary = getDashboardSummary()
    
    return {
      greeting: getTimeAwareGreeting(),
      motivationalQuote: getMotivationalQuote(),
      overallStatus: summary?.status === 'urgent' ? 'critical' : 
                    summary?.status === 'needs_attention' ? 'needs-attention' : 'on-track',
      keyMetrics: {
        profileScore: metrics?.profileCompletionPercentage || 0,
        upcomingDeadlines: metrics?.urgentDeadlines || 0,
        budgetHealth: preferences?.budgetRange ? 'Set' : 'Not Set',
        matchedPrograms: recommendedPrograms?.length || 0
      },
      nextBestAction: {
        text: summary?.actionNeeded ? 'Complete urgent tasks' : 'Continue building your profile',
        action: () => navigate(summary?.actionNeeded ? '/dashboard/applications' : '/dashboard/profile'),
        priority: summary?.actionNeeded ? 'high' : 'medium'
      }
    }
  }

  // Transform insights to notifications
  const transformInsightsToNotifications = (): SmartNotification[] => {
    return insights.map((insight) => {
      const iconMap = {
        urgent: <AlertCircleIcon className="w-5 h-5" style={{ color: akadaTokens.colors.status.error }} />,
        opportunity: <SparklesIcon className="w-5 h-5" style={{ color: akadaTokens.colors.status.warning }} />,
        success: <CheckCircleIcon className="w-5 h-5" style={{ color: akadaTokens.colors.status.success }} />,
        warning: <AlertCircleIcon className="w-5 h-5" style={{ color: akadaTokens.colors.status.warning }} />,
        info: <InfoIcon className="w-5 h-5" style={{ color: akadaTokens.colors.status.info }} />
      }

      return {
        id: insight.id,
        type: insight.type === 'urgent' ? 'deadline' : 
              insight.type === 'opportunity' ? 'opportunity' :
              insight.title.includes('Budget') || insight.title.includes('Cost') ? 'budget' :
              insight.title.includes('Profile') ? 'profile' : 'tip',
        priority: insight.priority === 'high' ? 'urgent' : insight.priority as any,
        title: insight.title,
        message: insight.message,
        action: insight.action ? {
          label: insight.action,
          onClick: () => insight.actionUrl && navigate(insight.actionUrl)
        } : undefined,
        dismissible: insight.dismissible,
        icon: iconMap[insight.type] || iconMap.info,
        timestamp: insight.timestamp
      }
    })
  }

  // Generate quick actions based on context
  const generateQuickActions = (): QuickAction[] => {
    const contextActions = getQuickActions()
    
    return contextActions.map((action) => {
      const iconMap = {
        'üë§': <UserIcon className="w-5 h-5" />,
        '‚è∞': <CalendarIcon className="w-5 h-5" />,
        'üîç': <GlobeIcon className="w-5 h-5" />,
        'üí∞': <DollarSignIcon className="w-5 h-5" />
      }

      const colorMap = {
        high: 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-700 dark:text-red-300',
        medium: 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800 text-blue-700 dark:text-blue-300',
        low: 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800 text-green-700 dark:text-green-300'
      }

      return {
        id: action.id,
        label: action.label,
        description: `Navigate to ${action.label.toLowerCase()}`,
        icon: iconMap[action.icon as keyof typeof iconMap] || <BookOpenIcon className="w-5 h-5" />,
        onClick: () => navigate(action.url),
        priority: action.priority as any,
        color: colorMap[action.priority as keyof typeof colorMap]
      }
    })
  }

  // Handle refresh with loading state
  const handleRefresh = useCallback(async () => {
    setIsRefreshing(true)
    await refreshDashboard()
    setTimeout(() => setIsRefreshing(false), 1000) // Show loading for UX
  }, [refreshDashboard])

  // Widget management
  const toggleWidget = (widget: keyof typeof widgetVisibility) => {
    const newVisibility = { ...widgetVisibility, [widget]: !widgetVisibility[widget] }
    setWidgetVisibility(newVisibility)
    try {
      localStorage.setItem('akada_widget_visibility', JSON.stringify(newVisibility))
    } catch (error) {
      console.warn('Failed to save widget preferences:', error)
    }
  }

  // Load saved widget preferences
  useEffect(() => {
    try {
      const saved = localStorage.getItem('akada_widget_visibility')
      if (saved && saved !== '[object Object]') {
        const parsed = JSON.parse(saved)
        if (typeof parsed === 'object' && parsed !== null) {
          setWidgetVisibility(parsed)
        }
      }
    } catch (error) {
      console.warn('Failed to load widget preferences:', error)
      // Clear corrupted data
      localStorage.removeItem('akada_widget_visibility')
    }
  }, [])

  // Check if user is new (no meaningful data)
  const isNewUser = (!profileData?.completionData || 
                   (profileData.completionData.percentage < 10 && 
                    (!timelineData?.applications?.length) &&
                    (!costData?.budgetAnalysis))) &&
                   !loading // Don't show new user flow while loading

  if (loading) {
    return (
      <div className={cn("space-y-6", className)}>
        {/* Dashboard banner skeleton */}
        <div className="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-6">
          <div className="space-y-4">
            <SkeletonLoader.Line width="w-1/2" height="h-6" />
            <SkeletonLoader.Line width="w-1/3" height="h-4" />
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[1,2,3,4].map(i => (
                <div key={i} className="space-y-2">
                  <SkeletonLoader.Line width="w-full" height="h-8" />
                  <SkeletonLoader.Line width="w-3/4" height="h-3" />
                </div>
              ))}
            </div>
          </div>
        </div>
        
        {/* Widget skeletons */}
        <SkeletonLoader.DashboardGrid />
      </div>
    )
  }

  if (isNewUser) {
    return <WelcomeDashboard />
  }

  const dashboardSummary = generateDashboardSummary()
  const smartNotifications = transformInsightsToNotifications()
  const quickActions = generateQuickActions()

  // Prepare metrics for glass components
  const glassMetrics = [
    { 
      value: `${dashboardSummary.keyMetrics.profileScore}%`, 
      label: 'Profile Complete',
      accentColor: dashboardSummary.keyMetrics.profileScore >= 80 ? 'green' : dashboardSummary.keyMetrics.profileScore >= 50 ? 'orange' : 'blue'
    },
    { 
      value: dashboardSummary.keyMetrics.upcomingDeadlines, 
      label: 'Urgent Deadlines',
      accentColor: dashboardSummary.keyMetrics.upcomingDeadlines > 0 ? 'orange' : 'blue'
    },
    { 
      value: dashboardSummary.keyMetrics.matchedPrograms, 
      label: 'Program Matches',
      accentColor: 'purple'
    },
    { 
      value: dashboardSummary.keyMetrics.budgetHealth, 
      label: 'Budget Status',
      accentColor: dashboardSummary.keyMetrics.budgetHealth === 'Set' ? 'green' : 'orange'
    },
  ]

  return (
    <div className={`min-h-screen ${isDark 
      ? 'bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950' 
      : 'bg-gradient-to-br from-indigo-50/30 via-purple-50/20 to-pink-50/30'
    }`}>
      {/* Background Effects */}
      {isDark ? (
        <>
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(99,102,241,0.08),transparent_50%)]" />
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_70%_60%,rgba(139,92,246,0.08),transparent_50%)]" />
        </>
      ) : (
        <>
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_30%_20%,rgba(99,102,241,0.15),transparent_60%)]" />
          <div className="fixed inset-0 bg-[radial-gradient(circle_at_70%_60%,rgba(168,85,247,0.12),transparent_60%)]" />
        </>
      )}
      
      <main className={cn("relative z-10 space-y-6 px-8 py-6", className)} role="main" aria-label="Dashboard">
        {/* Hero Section with Glass Cards */}
        <div className="space-y-4">
          {isDark ? (
            <GlassWelcomeCardDark 
              userName={profile?.full_name?.split(' ')[0] || user?.email?.split('@')[0] || 'Student'}
              greeting={getTimeAwareGreeting().split(',')[0]}
              subtitle={dashboardSummary.motivationalQuote}
            />
          ) : (
            <GlassWelcomeCard 
              userName={profile?.full_name?.split(' ')[0] || user?.email?.split('@')[0] || 'Student'}
              greeting={getTimeAwareGreeting().split(',')[0]}
              subtitle={dashboardSummary.motivationalQuote}
            />
          )}
          
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div className="lg:col-span-2">
              {isDark ? (
                <GlassStatsGridDark metrics={glassMetrics} />
              ) : (
                <GlassStatsGrid metrics={glassMetrics} />
              )}
            </div>
            <div>
              {isDark ? (
                <GlassActionCardDark 
                  title={dashboardSummary.nextBestAction.text}
                  subtitle="Take the next step in your journey"
                  buttonText="Take Action"
                  onButtonClick={dashboardSummary.nextBestAction.action}
                  icon={<Target className="w-6 h-6 text-indigo-400" />}
                />
              ) : (
                <GlassActionCard 
                  title={dashboardSummary.nextBestAction.text}
                  subtitle="Take the next step in your journey"
                  buttonText="Take Action"
                  onButtonClick={dashboardSummary.nextBestAction.action}
                  icon={<Target className="w-6 h-6 text-indigo-600" />}
                />
              )}
            </div>
          </div>
        </div>

        {/* Priority Notifications */}
        {widgetVisibility.notifications && smartNotifications.length > 0 && (
          <div className={`relative overflow-hidden rounded-2xl backdrop-blur-xl border p-6 ${
            isDark 
              ? 'bg-gray-900/40 border-white/10' 
              : 'bg-white/80 border-gray-200'
          }`} role="region" aria-live="polite" aria-label="Dashboard notifications">
            <div className="relative z-10">
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center space-x-2">
                  <BellIcon className="w-5 h-5 text-indigo-600" aria-hidden="true" />
                  <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                    Notifications
                  </h3>
                  {hasUrgentNotifications && (
                    <span className="bg-red-100 dark:bg-red-900/20 text-red-800 dark:text-red-300 text-xs font-medium px-2.5 py-0.5 rounded-full" aria-label={`${urgentCount} urgent notifications`}>
                      {urgentCount} urgent
                    </span>
                  )}
                </div>
                
                <div className="flex items-center space-x-2">
                  <button
                    onClick={() => setShowAllInsights(!showAllInsights)}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    {showAllInsights ? 'Show Less' : 'Show All'}
                  </button>
                  <button
                    onClick={() => setExpandedNotifications(!expandedNotifications)}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    {expandedNotifications ? <ChevronUpIcon className="w-5 h-5" /> : <ChevronDownIcon className="w-5 h-5" />}
                  </button>
                  <button
                    onClick={() => toggleWidget('notifications')}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                    aria-label="Hide notifications widget"
                  >
                    <EyeOffIcon className="w-5 h-5" aria-hidden="true" />
                  </button>
                </div>
              </div>
              
              {expandedNotifications && (
                <div className="space-y-3">
                  {(showAllInsights ? smartNotifications : smartNotifications.slice(0, 3)).map((notification) => (
                    <div
                      key={notification.id}
                      className={cn(
                        "p-4 rounded-lg border backdrop-blur-sm",
                        notification.priority === 'urgent' 
                          ? "bg-red-50/80 dark:bg-red-900/20 border-red-200 dark:border-red-800"
                          : notification.priority === 'high'
                          ? "bg-orange-50/80 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800"
                          : "bg-gray-50/80 dark:bg-gray-700/50 border-gray-200 dark:border-gray-600"
                      )}
                    >
                      <div className="flex items-start space-x-3">
                        <div className="flex-shrink-0">
                          {notification.icon}
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900 dark:text-white">
                                {notification.title}
                              </h4>
                              <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                {notification.message}
                              </p>
                            </div>
                            
                            <div className="flex items-center space-x-2 ml-3">
                              {notification.action && (
                                <button
                                  onClick={notification.action.onClick}
                                  className="text-xs bg-indigo-600 dark:bg-indigo-500 text-white px-3 py-1 rounded-md hover:bg-indigo-700 dark:hover:bg-indigo-600 transition-colors"
                                >
                                  {notification.action.label}
                                </button>
                              )}
                              
                              {notification.dismissible && (
                                <button
                                  onClick={() => dismissInsight(notification.id)}
                                  className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                                >
                                  <XIcon className="w-4 h-4" />
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                  
                  {smartNotifications.length > 3 && !showAllInsights && (
                    <button
                      onClick={() => setShowAllInsights(true)}
                      className="w-full text-center text-indigo-600 dark:text-indigo-400 text-sm font-medium py-2 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors"
                    >
                      View {smartNotifications.length - 3} more notifications
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        )}

        {/* Three-Column Dashboard Layout */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column: Application Timeline Widget */}
          {widgetVisibility.timeline && (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div></div>
                <button
                  onClick={() => toggleWidget('timeline')}
                  className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  aria-label="Hide application timeline widget"
                >
                  <EyeOffIcon className="w-4 h-4" aria-hidden="true" />
                </button>
              </div>
              <GlassTimelineWidget />
            </div>
          )}

          {/* Middle Column: Cost Analysis Widget */}
          {widgetVisibility.cost && (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div></div>
                <button
                  onClick={() => toggleWidget('cost')}
                  className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  aria-label="Hide cost analysis widget"
                >
                  <EyeOffIcon className="w-4 h-4" aria-hidden="true" />
                </button>
              </div>
              <GlassCostWidget />
            </div>
          )}

          {/* Right Column: Profile Completion, Reminders, and Quick Actions */}
          <div className="space-y-6">
            {/* Profile Completion Widget */}
            {widgetVisibility.profile && (
              <div>
                <div className="flex items-center justify-between mb-2">
                  <div></div>
                  <button
                    onClick={() => toggleWidget('profile')}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                    aria-label="Hide profile completion widget"
                  >
                    <EyeOffIcon className="w-4 h-4" aria-hidden="true" />
                  </button>
                </div>
                <GlassProfileWidget />
              </div>
            )}

            {/* Quick Actions Widget */}
            {widgetVisibility.quickActions && (
              <div>
                <div className="flex items-center justify-between mb-2">
                  <div></div>
                  <button
                    onClick={() => toggleWidget('quickActions')}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                    aria-label="Hide quick actions widget"
                  >
                    <EyeOffIcon className="w-4 h-4" aria-hidden="true" />
                  </button>
                </div>
                <GlassQuickActionsWidget />
              </div>
            )}

            {/* Reminder Widget */}
            {widgetVisibility.reminders && (
              <div>
                <div className="flex items-center justify-between mb-2">
                  <div></div>
                  <button
                    onClick={() => toggleWidget('reminders')}
                    className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                    aria-label="Hide reminders widget"
                  >
                    <EyeOffIcon className="w-4 h-4" aria-hidden="true" />
                  </button>
                </div>
                <GlassReminderWidget />
              </div>
            )}
          </div>
        </div>

        {/* Cost Comparison Chart - Full Width */}
        {widgetVisibility.chart && (
          <div>
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                Cost Comparison Analysis
              </h3>
              <button
                onClick={() => toggleWidget('chart')}
                className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                aria-label="Hide cost comparison chart widget"
              >
                <EyeOffIcon className="w-5 h-5" aria-hidden="true" />
              </button>
            </div>
            
            <Suspense fallback={<SkeletonLoader.CostChart />}>
              <CostComparisonChart />
            </Suspense>
          </div>
        )}

        {/* Hidden widgets recovery */}
        {Object.values(widgetVisibility).some(visible => !visible) && (
          <div className={`rounded-lg p-4 backdrop-blur-xl border ${
            isDark 
              ? 'bg-gray-900/40 border-white/10' 
              : 'bg-white/80 border-gray-200'
          }`}>
            <h4 className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
              Hidden Widgets
            </h4>
            <div className="flex flex-wrap gap-2">
              {Object.entries(widgetVisibility).map(([widget, visible]) => 
                !visible && (
                  <button
                    key={widget}
                    onClick={() => toggleWidget(widget as keyof typeof widgetVisibility)}
                    className="flex items-center space-x-2 px-3 py-2 bg-white dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    aria-label={`Show ${widget} widget`}
                  >
                    <EyeIcon className="w-4 h-4" aria-hidden="true" />
                    <span className="capitalize">{widget}</span>
                    <PlusIcon className="w-3 h-3" aria-hidden="true" />
                  </button>
                )
              )}
            </div>
          </div>
        )}

        {/* Footer */}
        <footer className={`mt-12 pt-6 border-t text-center ${
          isDark ? 'border-white/10' : 'border-gray-200'
        }`}>
          <p className={`text-sm ${isDark ? 'text-gray-400' : 'text-gray-600'}`}>
            ¬© 2025 Akada - All rights Reserved
          </p>
        </footer>
      </main>
    </div>
  )
}

export default ModernDashboard
